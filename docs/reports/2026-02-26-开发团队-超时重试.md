# 开发团队汇报 - 2026-02-26（生成行程超时与重试体感）

## 任务来源

docs/tasks/2026-02-26-开发团队-超时重试.md：落实 BACKLOG #20（20.1～20.3）及 Render 请求超时确认。

---

## 0. Render 请求超时确认

| 项目 | 结论 |
|------|------|
| **来源** | Render 官方 [Free 文档](https://render.com/docs/free) 未明确写出「HTTP 请求超时秒数」；社区与故障排查反馈普遍为 **约 30 秒**（免费 tier 平台层限制，用户不可配置）。 |
| **影响** | 当前 travel-mvp1 为 **Free 实例**。若平台存在 ~30s 请求上限，则后端将 DeepSeek 单次超时调到 90～120s 后，**仍可能被 Render 在约 30s 先断开连接**，用户端会看到 503 或连接中断。 |
| **建议** | ① **短期**：在 Render 环境变量中设置 `DEEPSEEK_TIMEOUT_SECONDS=25`，使后端在平台断连前先返回 `TIMEOUT`，前端展示「生成超时，请点击重试」+ 重试按钮，体感可接受。② **若需单次长时生成**：需与架构/项目经理确认方案（升级付费实例取消或放宽该限制、或改为异步任务等）。 |
| **待决** | 是否升级 Render 付费实例以解除请求超时限制，由项目经理/架构拍板。 |

---

## 20.1 调大「生成行程」超时

| 项目 | 说明 |
|------|------|
| **实现** | `src/lib/llm.py`：`DEEPSEEK_TIMEOUT_SECONDS` 默认由 30 改为 **120**；`DEEPSEEK_RETRY_MAX` 默认由 2 改为 **1**（减少总等待，配合前端重试）。 |
| **配置** | 仍通过环境变量 `DEEPSEEK_TIMEOUT_SECONDS`、`DEEPSEEK_RETRY_MAX` 可调。Render 免费版建议在 Environment 中设 `DEEPSEEK_TIMEOUT_SECONDS=25`，以便在平台 ~30s 前主动返回 TIMEOUT。 |
| **验收** | 本地或付费实例下配置生效后，单次尝试可覆盖「冷启动 + 生成」；Render 超时结论已记录于上节。 |

---

## 20.2 TIMEOUT 专用文案

| 项目 | 说明 |
|------|------|
| **实现** | `frontend/app.js`：当 API 返回 `code === 'TIMEOUT'` 时，展示 **「生成超时，请点击重试」**，与 DEEPSEEK_ERROR 等「请稍后再试」区分。 |
| **验收** | 用户看到超时错误时为「可重试」类文案。 |

---

## 20.3 失败态「重试」按钮

| 项目 | 说明 |
|------|------|
| **实现** | 错误展示区（`#error`）在展示错误文案的同时，增加 **「重试」按钮**；提交时保存本次参数到 `window.lastSubmitData`，点击重试时用该参数再次请求 `POST /api/generate-plan`，不刷新页面、不丢失表单。 |
| **逻辑** | 抽取 `doSubmit(data)`，表单 submit 与重试按钮均调用；失败后只要存在 `lastSubmitData` 即显示重试按钮。 |
| **验收** | 失败后点击重试即可再次生成，无需重新填表。 |

---

## 涉及文件

- `src/lib/llm.py`（默认超时 120s、默认重试 1 次）
- `frontend/app.js`（TIMEOUT 文案、doSubmit、lastSubmitData、重试按钮）
- `frontend/style.css`（`.btn-retry` 样式）

---

## 待决项（需架构/项目经理）

- **Render 免费版 ~30s 请求上限**：若需单次长时间生成（如 90～120s 不中断），需评估升级付费实例或异步方案；当前方案为「25s 后端超时 + 前端重试」以在免费版下获得可接受体感。
