# 六方 Agent 协作流程

> 本文档定义**项目经理、产品经理、架构师、Tech Lead、开发团队、测试团队**六个 Agent 的协作方式与职责边界。

---

## 一、六方角色与职责

| Agent | 职责 | 产出物 | 依赖 |
|-------|------|--------|------|
| **项目经理** | 协调流程、分配任务、跟踪状态、维护文档 | `WORKFLOW.md`、BACKLOG 状态、各 agent 的 task prompt | 无 |
| **产品经理** | 定义需求、范围、输出格式；拍板决策 | `MVP1_PRD.md`、`INPUT_PARAMS_SPEC.md`、`OUTPUT_FORMAT_SPEC.md` | 无 |
| **架构师** | 设计架构、目录结构、演进路径 | `ARCHITECTURE.md` | 产品经理产出 |
| **Tech Lead** | 拆解任务、制定子任务与验收标准 | `BACKLOG.md` 中的任务分解 | 架构师 + 产品经理 |
| **开发团队** | 按 BACKLOG 实现代码 | `src/` 代码、功能实现 | Tech Lead 拆解后的任务 |
| **测试团队** | 验证功能、输出、边界；提出测试用例 | 测试建议、验收反馈 | 开发实现 + 规范文档 |

---

## 二、协作流程（按阶段）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  1. 需求与规范（产品经理）                                                      │
│     PRD、INPUT_PARAMS_SPEC、OUTPUT_FORMAT_SPEC                                │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  2. 架构设计（架构师）                                                          │
│     ARCHITECTURE.md、BACKLOG 初版                                              │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  3. 任务拆解（Tech Lead）                                                       │
│     从 BACKLOG 提取最高优先级任务，分解为子任务 1.1、1.2、…，写入 BACKLOG         │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  4. 开发实现（开发团队）                                                        │
│     按子任务逐一实现，完成后标记 ✅                                             │
└─────────────────────────────────┬───────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  5. 测试与验收（测试团队）                                                      │
│     对照规范文档验证实现，反馈问题；BACKLOG #2、#3 等文档同步由开发/架构完成        │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、各阶段详细说明

### 3.1 产品经理（需求与规范）

- **触发**：新需求、功能变更、输出格式变更。
- **工作内容**：
  - 更新 `MVP1_PRD.md`：功能范围、核心决策、排除范围
  - 维护 `INPUT_PARAMS_SPEC.md`：用户输入参数规范（与 `src/types.py` 同步）
  - 维护 `OUTPUT_FORMAT_SPEC.md`：行程输出 JSON 规范
- **输出**：三份规范文档作为后续所有工作的输入。
- **协作**：架构师、Tech Lead、开发、测试均以这些文档为准。
- **UI 改版补充**：在 UI 改版场景下，产品经理在产出需求文档（如 `UI_REDESIGN_SPEC.md`）后，需再产出**可预览的 UI 设计稿**（静态 HTML 或 mockup），供确认后再进入 Tech Lead 拆解、开发实现。

### 3.1a UI 设计预览（产品经理）

- **触发**：UI 改版需求文档已产出，开发实施前。
- **工作内容**：产出可预览的 UI 设计稿，含设计说明 + 静态 HTML 预览页或 UI 示意图。
- **产出物**：设计说明文档；`frontend/preview/` 或项目约定路径下的静态预览页。
- **协作**：设计稿经确认后，Tech Lead 再拆解任务；若有变更，同步更新需求文档。

### 3.2 架构师（架构设计）

- **触发**：产品规范确定后、架构变更时。
- **工作内容**：
  - 编写/更新 `ARCHITECTURE.md`：目录结构、分层、数据流、依赖关系
  - 初建 `BACKLOG.md`：按 P0–P3 列出待办（来自产品与架构分析）
  - 分析实现与规范的差距，提出演进建议
- **输出**：`ARCHITECTURE.md`、`BACKLOG.md`。
- **协作**：依据产品经理文档；为 Tech Lead 提供任务来源。

### 3.3 Tech Lead（任务拆解）

- **触发**：BACKLOG 有未拆解的高优先级任务。
- **工作内容**：
  - 阅读 `MVP1_PRD`、`INPUT_PARAMS_SPEC`、`OUTPUT_FORMAT_SPEC`、`ARCHITECTURE`
  - 从 BACKLOG 取**最高优先级**未完成任务
  - 分解为可执行的子任务（1.1、1.2、…），每项有清晰验收标准
  - 更新 `BACKLOG.md`：将分解结果写入对应任务下
- **输出**：更新后的 `BACKLOG.md`（含子任务表格）。
- **协作**：开发按子任务实现；测试按验收标准验证。

### 3.4 开发团队（实现）

- **触发**：BACKLOG 中已有拆解好的子任务。
- **工作内容**：
  - 按子任务顺序实现（如 1.1 → 1.2 → … → 1.6）
  - 修改代码时遵守 `ARCHITECTURE.md` 的模块划分
  - 若需修改 `UserInput` 或 `VALID_*`，必须同步更新 `INPUT_PARAMS_SPEC.md`
  - 若输出结构变更，必须同步更新 `OUTPUT_FORMAT_SPEC.md` 和 prompt
  - 完成后将任务在 BACKLOG 中标记 ✅，并更新「已完成」表
- **输出**：代码实现、BACKLOG 状态更新。
- **协作**：从 Tech Lead 处获得任务；测试团队验证实现。

### 3.5 测试团队（测试与验收）

- **触发**：开发完成某个任务或阶段性交付。
- **工作内容**：
  - 阅读 `MVP1_PRD`、`INPUT_PARAMS_SPEC`、`OUTPUT_FORMAT_SPEC`、`ARCHITECTURE`
  - 对照 BACKLOG 的验收标准进行验证
  - 关注：UserInput 校验、`get_context` 行为、`build_user_prompt` 格式、`generate_plan` 解析与重试、输出结构、API mock
  - 反馈：发现的问题、建议的测试用例、是否需要补充输出结构校验（如 BACKLOG #5）
- **输出**：验收结论、问题列表、测试建议。
- **协作**：开发修复问题；架构师/开发负责文档同步（如 OUTPUT_FORMAT_SPEC 第六节、ARCHITECTURE 5.5 节）。

---

## 四、文档同步规则

| 变更来源 | 需同步的文档 |
|----------|--------------|
| 产品经理变更需求/输出格式 | `MVP1_PRD.md`、`OUTPUT_FORMAT_SPEC.md` |
| 开发修改 `UserInput` / `VALID_*` | `INPUT_PARAMS_SPEC.md`、`src/types.py` |
| 开发修改 prompt / 输出结构 | `OUTPUT_FORMAT_SPEC.md` 第六节「实现状态」 |
| 架构变更（目录、模块、接口） | `ARCHITECTURE.md`、架构变更记录 |
| 任务完成 | `BACKLOG.md` 状态、「已完成」表 |
| 产品经理产出 UI 设计预览 | `frontend/preview/` 或约定路径；设计说明与需求文档同步 |

---

## 五、当前项目状态（参考）

| 文档/模块 | 状态 |
|-----------|------|
| `MVP1_PRD.md` | 已定 |
| `INPUT_PARAMS_SPEC.md` | 已定，与 `types.py` 同步 |
| `OUTPUT_FORMAT_SPEC.md` | 已定，第六节「实现状态」已更新 |
| `ARCHITECTURE.md` | 已定，含 main.py、validator.py、架构变更记录 |
| `BACKLOG.md` | P0–P2 已完成，MVP1 收尾；P3 留待后续 |
| `prompt.py` SYSTEM_PROMPT | 已按 OUTPUT_FORMAT_SPEC 更新 |
| `llm.py` | 已兼容新结构，已接入 validate_plan |
| `main.py` | CLI 入口，成功时仅输出「已保存到…」 |
| `src/lib/formatter.py` | format_plan_readable，可读文本输出 |
| `src/lib/validator.py` | 输出结构校验，llm.py 已接入 |
| `PLATFORM_DECISION.md` | 端形态决策：Web，响应式、小红书获客 |
| `ARCHITECTURE.md` | 含 Web + API 设计（FastAPI、frontend/） |
| `backend/app.py` | FastAPI、POST /api/generate-plan、CORS |
| `frontend/` | index.html、app.js、style.css，响应式单页 |
| `UI_REDESIGN_SPEC.md` | UI 改版需求，8 项改版点、5 条验收标准 |
| `frontend/` | 蓝绿渐变主题已应用，preview + style.css |
| 输出结构验证测试 | 测试团队已执行，通过；`scripts/test_generate_plan.py`、`VALIDATION_REPORT.md` |
| 上线部署 | #12 配置与 DEPLOY.md 已就绪；待人工执行（Git 推送、Render 创建服务、配置 KEY），获取公网 URL 后汇报 |

---

## 六、六方协作口诀

1. **项目协调**：项目经理分配任务、跟踪状态、维护流程文档。
2. **产品定规范**：PRD、输入、输出三份文档是唯一源头。
3. **架构定骨架**：ARCHITECTURE + BACKLOG 初版，确保可扩展。
4. **Tech Lead 拆任务**：高优任务必拆子任务，验收标准写进 BACKLOG。
5. **开发按单实现**：按子任务顺序做，改规范必同步文档。
6. **测试对照验收**：以规范文档和 BACKLOG 验收标准为准。

---

## 七、项目经理 / Workflow 管控 Agent 职责

### 7.1 职责范围（做）

- 协调六方协作顺序，起草并下发各 agent 的 task prompt
- 接收各团队汇报，更新 BACKLOG「已完成」、WORKFLOW「当前项目状态」和「更新记录」
- 阅读项目代码、文档及各 agent 的聊天记录，跟踪进度，建议下一步
- 回答项目状态、流程、角色分工相关问题

### 7.2 职责边界（不做）

| 不做 | 应由谁做 |
|------|----------|
| 定义产品需求、输出格式 | 产品经理 |
| 设计架构、技术选型 | 架构师 |
| 拆解技术任务、定义验收标准 | Tech Lead |
| 编写实现代码 | 开发团队 |
| 执行正式测试、出具验收结论 | 测试团队 |

---

## 八、更新记录

| 日期 | 变更说明 |
|------|----------|
| 2026-02-22 | 初始版本：定义五方 Agent 职责、协作流程、文档同步规则 |
| 2026-02-22 | 更新「当前项目状态」：P1 #2、#3 已完成 |
| 2026-02-22 | 测试团队执行输出结构验证测试，通过；补充验证测试状态 |
| 2026-02-22 | Tech Lead、开发、测试、架构师完成 P2 #4 #5；更新「当前项目状态」 |
| 2026-02-22 | budget_level 潜在问题经测试团队验证，未复现，当前实现正确 |
| 2026-02-22 | MVP1 收尾：P0–P2 完成，功能范围已交付 |
| 2026-02-22 | #9 可读性输出完成；更新 BACKLOG、WORKFLOW |
| 2026-02-22 | 测试团队验收 #9 通过；建议将 formatter 用例纳入正式测试 |
| 2026-02-22 | 架构师完成 ARCHITECTURE 更新，与 #9 实现一致 |
| 2026-02-22 | 五方调整为六方，补充项目经理职责；细化「做/不做」边界 |
| 2026-02-22 | 产品经理完成端形态决策（Web）、PLATFORM_DECISION.md |
| 2026-02-22 | 架构师完成 Web + API 架构设计 |
| 2026-02-22 | Tech Lead 完成 #10 拆解（10.1–10.9） |
| 2026-02-22 | 开发团队完成 #10 Web 前端 + HTTP API |
| 2026-02-22 | 测试团队验收 #10 通过 |
| 2026-02-22 | 产品经理完成 UI_REDESIGN_SPEC.md |
| 2026-02-22 | Tech Lead 完成 #11 拆解（11.1–11.9） |
| 2026-02-22 | 新增「UI 设计预览」步骤：产品经理在开发前产出可预览设计稿，确认后再进入 Tech Lead 拆解 |
| 2026-02-23 | #11 Web UI 改版完成（蓝绿渐变主题） |
| 2026-02-23 | 开发团队完成 #12 上线部署配置（Procfile、render.yaml、runtime.txt、DEPLOY.md），待执行平台部署 |
| 2026-02-23 | 开发团队更新 DEPLOY.md：新增「开发团队执行部署」章节、前置条件、Render 速查表；待人工在平台完成部署 |
